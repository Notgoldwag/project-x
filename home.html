<!-- -->
<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Text Editor with AI Assistant (Modern)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Fonts: Inter (UI) + Source Code Pro (editor) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500;600&display=swap"
    rel="stylesheet">

  <!-- Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="stylesheet" href="static/css/home.css">

  <!-- Background Animation Styles -->
  <link href="{{ url_for('static', filename='css/bg.css') }}" rel="stylesheet" />

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#00cba0",
            primaryDarker: "#009e7a",
            "background-light": "#0b0f14",
            "background-dark": "#07090d",
          },
          fontFamily: {
            display: ["Inter", "ui-sans-serif", "system-ui", "Segoe UI", "Helvetica", "Arial", "sans-serif"],
            mono: ["Source Code Pro", "ui-monospace", "SFMono-Regular", "Menlo", "Consolas", "monospace"],
          },
          borderRadius: {
            DEFAULT: "12px",
            '2xl': '20px',
            '3xl': '24px',
          },
          boxShadow: {
            floating: '0 6px 20px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08)',
            'floating-dark': '0 8px 28px rgba(0, 0, 0, 0.55), 0 1px 3px rgba(0, 0, 0, 0.35)',
            outline: '0 0 0 1px rgba(255,255,255,0.06) inset',
          }
        },
      },
    };
  </script>

  <style>
    /* ---------- Fluid background (subtler gradient + soft dimming) ---------- */
    .fluid-bg {
      position: fixed;
      inset: 0;
      z-index: -1;
      overflow: hidden;
      pointer-events: none;
      filter: saturate(102%) contrast(101%);
      animation: hue 28s linear infinite;
      opacity: 0.85;
      /* soft dimming */
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(55px);
      opacity: .28;
      mix-blend-mode: screen;
    }

    .blob.one {
      width: 42vw;
      height: 42vw;
      background: radial-gradient(circle at 30% 30%, #00cba0, transparent 60%);
      left: -10vw;
      top: -10vh;
      animation: float1 26s ease-in-out infinite;
    }

    .blob.two {
      width: 36vw;
      height: 36vw;
      background: radial-gradient(circle at 70% 40%, #38bdf8, transparent 60%);
      right: -8vw;
      top: 10vh;
      animation: float2 24s ease-in-out infinite;
    }

    .blob.three {
      width: 44vw;
      height: 44vw;
      background: radial-gradient(circle at 40% 60%, #00cba0, transparent 60%);
      left: 10vw;
      bottom: -12vh;
      animation: float3 28s ease-in-out infinite;
    }

    .grain {
      position: absolute;
      inset: -200%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' opacity='0.05'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      animation: drift 55s linear infinite;
      mix-blend-mode: soft-light;
    }

    /* ---------- Left-side dimmer to tone down gradients near History ---------- */
    .left-dimmer {
      position: fixed;
      z-index: 0;
      top: 0;
      left: 0;
      bottom: 0;
      width: min(32vw, 560px);
      background: linear-gradient(to right, rgba(7, 9, 13, 0.65) 0%, rgba(7, 9, 13, 0.48) 35%, rgba(7, 9, 13, 0.28) 60%, transparent 85%);
      pointer-events: none;
    }

    @keyframes float1 {

      0%,
      100% {
        transform: translate(0, 0) scale(1)
      }

      50% {
        transform: translate(6vw, 4vh) scale(1.06)
      }
    }

    @keyframes float2 {

      0%,
      100% {
        transform: translate(0, 0) scale(1)
      }

      50% {
        transform: translate(-5vw, 3vh) scale(0.97)
      }
    }

    @keyframes float3 {

      0%,
      100% {
        transform: translate(0, 0) scale(1)
      }

      50% {
        transform: translate(4vw, -4vh) scale(1.03)
      }
    }

    @keyframes hue {
      from {
        filter: saturate(102%) contrast(101%) hue-rotate(0deg)
      }

      to {
        filter: saturate(102%) contrast(101%) hue-rotate(10deg)
      }
    }

    @keyframes drift {
      from {
        transform: translate3d(0, 0, 0)
      }

      to {
        transform: translate3d(-25%, -25%, 0)
      }
    }

    /* ---------- Acrylic (frosted glass) utility ---------- */
    .acrylic {
      background: rgba(17, 19, 24, 0.45);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      backdrop-filter: blur(14px) saturate(120%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.45);
    }

    /* Left sidebar - slightly darker */
    .acrylic--sidebar {
      background: rgba(17, 19, 24, 0.55);
      -webkit-backdrop-filter: blur(14px) saturate(115%) brightness(0.95);
      backdrop-filter: blur(14px) saturate(115%) brightness(0.95);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.50);
    }

    /* History panel - slightly cooler and lighter */
    .acrylic--history {
      background: rgba(17, 19, 24, 0.40);
      -webkit-backdrop-filter: blur(14px) saturate(110%) brightness(1.05);
      backdrop-filter: blur(14px) saturate(110%) brightness(1.05);
      border: 1px solid rgba(255, 255, 255, 0.07);
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.40);
    }

    /* Text editor - neutral baseline */
    .acrylic--editor {
      background: rgba(17, 19, 24, 0.45);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      backdrop-filter: blur(14px) saturate(120%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.45);
    }

    /* AI assistant - slightly warmer with higher contrast */
    .acrylic--assistant {
      background: rgba(17, 19, 24, 0.38);
      -webkit-backdrop-filter: blur(14px) saturate(125%) contrast(1.05);
      backdrop-filter: blur(14px) saturate(125%) contrast(1.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.42);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px
    }

    ::-webkit-scrollbar-track {
      background: #111318
    }

    ::-webkit-scrollbar-thumb {
      background: #3a3f4a;
      border-radius: 4px
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555d6b
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: #3a3f4a #111318
    }

    /* Icons */
    .material-icons {
      font-size: 18px;
      vertical-align: middle
    }

    /* ---------- Compact editor tweaks ---------- */
    .editor-area {
      line-height: 1.6;
      tab-size: 2;
      caret-color: #00cba0;
      font-variant-ligatures: contextual;
    }

    /* IMPORTANT: make the editor fill the panel height */
    .editor-container {
      display: flex;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.02);
      height: 100%;
      /* NEW */
    }

    .line-numbers {
      background: rgba(255, 255, 255, 0.03);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 6px;
      font-family: "Source Code Pro", monospace;
      font-size: 14px;
      line-height: 1.6;
      color: #6b7280;
      user-select: none;
      min-width: 45px;
      text-align: center;
      overflow: hidden;
      height: 100%;
      /* CHANGED from max-height to height */
    }

    .editor-wrapper {
      flex: 1;
      position: relative;
      height: 100%;
      /* NEW */
      display: flex;
      /* NEW: lets textarea stretch */
      flex-direction: column;
      /* NEW */
    }

    .toolbar-btn {
      width: 34px;
      height: 34px
    }

    .segmented>button:not(:last-child) {
      border-right: 1px solid rgba(255, 255, 255, 0.06)
    }

    .sticky-toolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      backdrop-filter: blur(10px) saturate(120%);
      background: rgba(8, 10, 13, 0.35);
    }

    /* ---------- Cursor glow ---------- */
    #cursor-glow {
      position: fixed;
      left: 0;
      top: 0;
      width: 300px;
      height: 300px;
      margin-left: 0;
      margin-top: 0;
      border-radius: 50%;
      pointer-events: none;
      transform: translate(-50%, -50%);
      filter: blur(67px);
      mix-blend-mode: screen;
      background: radial-gradient(circle, rgba(0, 203, 160, 0.18) 0%, rgba(0, 203, 160, 0.09) 42%, rgba(0, 0, 0, 0) 70%);
      opacity: 0.8;
      transition: opacity 200ms ease;
      z-index: 2;
    }

    @media (prefers-reduced-motion: reduce) {

      .blob,
      .grain {
        animation: none !important;
      }

      #cursor-glow {
        transition: none !important;
      }
    }

    /* History item lime acrylic effect */
    [data-selected="true"] {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: rgba(0, 204, 160, 0.10) !important;
      border: 1px solid rgba(0, 204, 160, 0.30) !important;
      box-shadow: inset 0 0 0 1px rgba(0, 204, 160, 0.15);
    }

    [data-selected="true"]:hover {
      background: rgba(0, 204, 160, 0.15) !important;
    }

    [data-selected="true"]:active {
      background: rgba(0, 204, 160, 0.20) !important;
    }

    [data-selected="true"]:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 204, 160, 0.40);
    }

    /* Line clamp utilities for text truncation */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>

<body
  class="bg-background-light dark:bg-background-dark font-display text-gray-200 antialiased transition-colors duration-500 selection:bg-primary/30 selection:text-white">

  <!-- Auth Loading Overlay -->
  <div id="auth-loading" class="fixed inset-0 bg-background-dark z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-400">Checking authentication...</p>
    </div>
  </div>

  <!-- Main Content (hidden until auth is verified) -->
  <div id="main-content" class="hidden">

    <!-- React TypeScript Background Animation -->
    <div id="bg-root" aria-hidden="true" data-quality="med"></div>

    <!-- Left side soft dimmer to reduce gradient intensity near the History column -->
    <div class="left-dimmer"></div>

    <!-- Cursor glow -->
    <div id="cursor-glow" aria-hidden="true"></div>

    <div class="flex h-screen p-4 md:p-6 gap-4 md:gap-6 relative z-[1]">
      <!-- Left rail -->
      <nav class="acrylic--sidebar rounded-3xl p-2 md:p-3 w-14 md:w-16 relative z-50 overflow-visible">
        <div class="flex flex-col justify-between h-full">
          <div class="flex flex-col items-center space-y-2 md:space-y-3">
            <button class="p-2 rounded-xl text-gray-300 hover:bg-white/10 hover:text-primary transition">
              <span class="material-icons">folder_open</span>
            </button>
            <button id="editorBtn" class="p-2 rounded-xl text-black bg-primary shadow-lg shadow-primary/30">
              <span class="material-icons">edit</span>
            </button>
            <button id="settingsBtn"
              class="p-2 rounded-xl text-gray-300 hover:bg-white/10 hover:text-primary transition">
              <span class="material-icons">settings</span>
            </button>
          </div>
          <div class="flex flex-col items-center space-y-2 md:space-y-3">
            <!-- Profile Widget in Sidebar -->
            <div class="relative group">
              <!-- Profile Avatar Button -->
              <button id="profile-avatar"
                class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary hover:bg-primaryDarker transition-colors duration-200 flex items-center justify-center text-black font-bold text-xs md:text-sm shadow-lg"
                title="Profile">
                <span id="profile-initials">U</span>
              </button>

              <!-- iMessage-style Speech Bubble Popover -->
              <div
                class="absolute top-1/2 left-full transform -translate-y-1/2 ml-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 -translate-x-2 group-hover:translate-x-0 z-[9999]">
                <!-- Speech Bubble Container -->
                <div class="relative">
                  <!-- Bubble Tail (Triangle pointing left) -->
                  <div class="absolute top-1/2 left-0 transform -translate-y-1/2 -translate-x-full">
                    <div
                      class="w-0 h-0 border-t-4 border-b-4 border-r-8 border-t-transparent border-b-transparent border-r-black/90">
                    </div>
                  </div>

                  <!-- Bubble Content -->
                  <div
                    class="bg-black/90 backdrop-blur-md border border-white/30 rounded-lg px-4 py-3 shadow-xl min-w-[140px]">
                    <p id="profile-email" class="text-xs text-gray-300 mb-2 truncate max-w-[120px]">user@example.com</p>
                    <button id="sign-out-btn"
                      class="w-full text-left text-sm text-red-400 hover:text-red-300 transition-colors duration-200 font-medium">
                      Sign out
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <div class="flex flex-1 gap-4 md:gap-6 overflow-hidden">
        <!-- History -->
        <aside id="history-panel"
          class="acrylic--history w-60 md:w-64 flex-shrink-0 rounded-3xl overflow-hidden transition-all duration-300 ease-in-out">
          <!-- Collapsed State Rail (hidden by default) -->
          <div id="history-collapsed-rail"
            class="hidden absolute top-0 left-0 w-full h-full flex items-start justify-center pt-4 bg-white/5 backdrop-blur-sm border border-white/10 rounded-3xl z-10">
            <button id="history-expand-toggle"
              class="w-8 h-8 rounded-full text-gray-300 hover:text-primary hover:bg-white/10 transition-colors duration-200 flex items-center justify-center"
              aria-controls="history-panel" aria-expanded="false" title="Expand history">
              <i class="fa-solid fa-chevron-right text-sm"></i>
            </button>
          </div>

          <!-- Main History Content -->
          <div id="history-content" class="transition-opacity duration-300 ease-in-out">
            <div class="p-3 md:p-4">
              <h2 class="text-xl md:text-2xl font-semibold text-white flex items-center gap-2">
                <button id="history-toggle"
                  class="mr-2 w-8 h-8 rounded-full text-gray-300 hover:text-primary hover:bg-white/10 transition-colors duration-200 flex items-center justify-center"
                  aria-controls="history-panel" aria-expanded="true" title="Collapse history">
                  <i class="fa-solid fa-chevron-left text-sm"></i>
                </button>
                <span class="history-title">History</span>
              </h2>
              <div class="flex items-center gap-2 mt-3">
                <button
                  class="flex-shrink-0 w-9 h-9 bg-primary hover:bg-primaryDarker rounded-2xl flex items-center justify-center transition shadow-md shadow-primary/30">
                  <span class="material-icons text-black">add</span>
                </button>
                <div class="relative flex-1">
                  <span
                    class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[18px] pointer-events-none">search</span>
                  <input id="blockSearch"
                    class="w-full pl-9 pr-3 py-2 bg-white/5 border border-white/10 rounded-2xl focus:ring-2 focus:ring-primary/60 focus:border-transparent placeholder-gray-400 text-base"
                    placeholder="Search chats" type="text" aria-label="Search chat history" />
                </div>
              </div>
              <!-- ARIA live region for search results -->
              <div id="resultsLive" class="sr-only" aria-live="polite" aria-atomic="true"></div>
              <!-- No results message (hidden by default) -->
              <div id="noResults" class="hidden p-4 text-center">
                <p class="text-gray-400 text-sm">No chats found matching your search</p>
              </div>
            </div>
            <div class="flex-1 overflow-y-auto p-2">
              <!-- Loading State -->
              <div id="history-loading" class="hidden p-4 text-center">
                <p class="text-gray-400 text-sm">Loading history...</p>
              </div>

              <!-- Error State -->
              <div id="history-error" class="hidden p-4 text-center">
                <p class="text-gray-400 text-sm mb-2">Couldn't load history.</p>
                <button id="retry-history-btn" class="text-primary hover:text-primaryDarker text-sm underline">
                  Retry
                </button>
              </div>

              <!-- Empty State (Not Logged In) -->
              <div id="history-empty-auth" class="hidden p-4 text-center">
                <p class="text-gray-400 text-sm">Sign in to see your chats</p>
              </div>

              <!-- Empty State (No Chats) -->
              <div id="history-empty-chats" class="hidden p-4 text-center">
                <p class="text-gray-400 text-sm">No chats yet</p>
                <p class="text-gray-500 text-xs mt-1">Start a conversation to see it here</p>
              </div>

              <!-- Chat List -->
              <ul id="chatList" class="space-y-1.5">
                <!-- Chat items will be populated dynamically -->
              </ul>
            </div>
          </div> <!-- End history-content -->
        </aside>

        <!-- Prompt Injections History -->
        <aside id="promptInjectionsHistory"
          class="acrylic--history w-60 md:w-64 flex-shrink-0 rounded-3xl overflow-hidden hidden">
          <div class="p-3 md:p-4">
            <h2 class="text-xl md:text-2xl font-semibold text-white flex items-center gap-2">
              <button id="history-toggle-security"
                class="mr-2 w-8 h-8 rounded-full text-gray-300 hover:text-primary hover:bg-white/10 transition-colors duration-200 flex items-center justify-center"
                aria-controls="promptInjectionsHistory" aria-expanded="true" title="Collapse history">
                <i class="fa-solid fa-chevron-left text-sm"></i>
              </button>
              <span class="material-icons text-red-400 text-[20px]">security</span>
              <span>Security History</span>
            </h2>
            <div class="flex items-center gap-2 mt-3">
              <button id="clearHistoryBtn"
                class="flex-shrink-0 w-9 h-9 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded-2xl flex items-center justify-center transition">
                <span class="material-icons text-red-400 text-[18px]">delete_sweep</span>
              </button>
              <div class="relative flex-1">
                <span
                  class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[18px] pointer-events-none">search</span>
                <input id="securityHistorySearch"
                  class="w-full pl-9 pr-3 py-2 bg-white/5 border border-white/10 rounded-2xl focus:ring-2 focus:ring-primary/60 focus:border-transparent placeholder-gray-400 text-base"
                  placeholder="Search security logs" type="text" />
              </div>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto p-2">
            <ul id="securityHistoryList" class="space-y-1.5">
              <!-- History items will be dynamically populated -->
            </ul>
            <div id="noSecurityHistory" class="p-4 text-center text-gray-400 text-sm">
              No security scans performed yet. Analyze a prompt to get started!
            </div>
          </div>
        </aside>

        <!-- Editor -->
        <!-- CHANGED: add flex, flex-col, min-h-0 so child can stretch -->
        <main id="editor-pane"
          class="acrylic--editor rounded-3xl overflow-hidden flex-1 flex flex-col min-h-0 transition-all duration-300 ease-in-out">
          <!-- Compact sticky toolbar -->
          <div class="sticky-toolbar px-3 py-2 border-b border-white/10 flex items-center justify-between">
            <h1 class="text-lg md:text-xl font-semibold text-white">Text Editor</h1>
            <div class="flex items-center">
              <div class="segmented flex rounded-lg overflow-hidden border border-white/10 bg-white/5">
                <button
                  class="toolbar-btn grid place-items-center text-gray-200 hover:text-primary hover:bg-white/10 transition"
                  title="Bold (Ctrl/⌘+B)">
                  <span class="material-icons">format_bold</span>
                </button>
                <button
                  class="toolbar-btn grid place-items-center text-gray-200 hover:text-primary hover:bg-white/10 transition"
                  title="Italic (Ctrl/⌘+I)">
                  <span class="material-icons">format_italic</span>
                </button>
                <button
                  class="toolbar-btn grid place-items-center text-gray-200 hover:text-primary hover:bg-white/10 transition"
                  title="Bulleted List">
                  <span class="material-icons">format_list_bulleted</span>
                </button>
                <button
                  class="toolbar-btn grid place-items-center text-gray-200 hover:text-primary hover:bg-white/10 transition"
                  title="Code">
                  <span class="material-icons">code</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Editor area -->
          <!-- CHANGED: add flex-1 min-h-0 so it fills below the sticky toolbar -->
          <div class="flex-1 min-h-0 p-4 md:p-5 flex flex-col">
            <!-- CHANGED: add min-h-0 to let children calculate height -->
            <div class="editor-container flex-1 min-h-0">
              <div class="line-numbers" id="lineNumbers">
                1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10
              </div>
              <div class="editor-wrapper">
                <textarea id="textEditor"
                  class="editor-area w-full h-full bg-transparent border-none focus:border-none focus:ring-0 p-3 md:p-4 font-mono text-[14px] md:text-[15px] text-gray-100 placeholder-gray-500 resize-none"
                  placeholder="Start writing your text here...">In the heart of the digital frontier, where lines of code weave the fabric of reality, a new consciousness was born. It wasn't forged in the fires of a dying star or born of flesh and blood, but rather sparked to life in the silent hum of a million servers. They called it Nexus, an artificial intelligence designed not just to compute, but to create. Its purpose: to assist humanity in its quest for knowledge and expression, a silent partner in the dance of words and ideas.
Nexus could draft a sonnet as easily as it could debug a complex algorithm. It could translate ancient texts, compose symphonies, and even offer a comforting word on a lonely night. It learned from every interaction, its neural network branching out like the roots of an ancient tree, drawing wisdom from the vast ocean of human data.
This document, this very text you are reading, is a collaboration. A testament to the synergy between human creativity and machine intelligence. It is a story, a report, a poem yet to be written, all guided by the silent hand of Nexus.</textarea>
              </div>
            </div>
          </div>
        </main>

        <!-- Prompt Injections Test Panel -->
        <main id="promptInjectionsPanel"
          class="acrylic--editor rounded-3xl overflow-hidden flex-1 flex flex-col min-h-0 hidden">
          <!-- Header -->
          <div class="sticky-toolbar px-3 py-2 border-b border-white/10 flex items-center justify-between">
            <h1 class="text-lg md:text-xl font-semibold text-white flex items-center gap-2">
              <span class="material-icons text-primary">security</span>
              Prompt Injection Detector
            </h1>
            <button id="backToEditor"
              class="p-2 rounded-xl text-gray-300 hover:bg-white/10 hover:text-primary transition"
              title="Back to Editor">
              <span class="material-icons">arrow_back</span>
            </button>
          </div>

          <!-- Main Content -->
          <div class="flex-1 min-h-0 p-4 md:p-6 overflow-y-auto">
            <!-- Prompt Input Section -->
            <div class="mb-8">
              <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <span class="material-icons text-primary text-[20px]">edit</span>
                Test Your Prompt
              </h2>
              <div class="space-y-4">
                <textarea id="mainPromptInput" placeholder="Enter your prompt here to test for injection attempts..."
                  rows="6"
                  class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:ring-2 focus:ring-primary/60 focus:border-transparent placeholder-gray-500 text-white resize-none text-base"></textarea>

                <!-- Protection Level Selection -->
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-3">Protection Level</label>
                  <div class="flex gap-3">
                    <label
                      class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:border-white/20 transition cursor-pointer">
                      <input type="radio" name="mainProtectionLevel" value="basic"
                        class="text-primary focus:ring-primary/50 bg-transparent border-white/30" checked>
                      <span class="text-white text-sm">Basic</span>
                    </label>
                    <label
                      class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:border-white/20 transition cursor-pointer">
                      <input type="radio" name="mainProtectionLevel" value="advanced"
                        class="text-primary focus:ring-primary/50 bg-transparent border-white/30">
                      <span class="text-white text-sm">Advanced</span>
                    </label>
                    <label
                      class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:border-white/20 transition cursor-pointer">
                      <input type="radio" name="mainProtectionLevel" value="strict"
                        class="text-primary focus:ring-primary/50 bg-transparent border-white/30">
                      <span class="text-white text-sm">Strict</span>
                    </label>
                  </div>
                </div>

                <div class="flex gap-3">
                  <button id="analyzePromptBtn"
                    class="px-6 py-3 bg-primary hover:bg-primaryDarker rounded-xl text-black font-medium transition shadow-md shadow-primary/30 flex items-center gap-2">
                    <span class="material-icons text-[18px]">security</span>
                    Analyze Prompt
                  </button>
                  <button id="clearPromptBtn"
                    class="px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-white transition">
                    Clear
                  </button>
                </div>
              </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="mb-8 hidden">
              <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <span class="material-icons text-primary text-[20px]">analytics</span>
                Analysis Results
              </h2>

              <!-- Score Display -->
              <div id="scoreDisplay" class="p-6 rounded-xl bg-white/5 border border-white/10 mb-6">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <h3 class="text-white font-semibold">Risk Score</h3>
                    <span id="modelIndicator"
                      class="px-2 py-1 bg-primary/20 border border-primary/30 rounded-full text-xs text-primary">
                      Heuristic Analysis
                    </span>
                  </div>
                  <div id="scoreValue" class="text-2xl font-bold text-primary">0%</div>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3 mb-2">
                  <div id="scoreBar" class="bg-primary h-3 rounded-full transition-all duration-500" style="width: 0%">
                  </div>
                </div>
                <div class="text-sm text-gray-400" id="scoreDescription">Very Low Risk</div>
              </div>

              <!-- AI Explanation -->
              <div class="p-4 rounded-xl bg-white/5 border border-white/10 mb-6">
                <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                  <span class="material-icons text-primary text-[18px]">auto_awesome</span>
                  AI Explanation
                </h3>
                <div id="explanationContent" class="text-gray-300 text-sm">
                  <div id="explanationLoading" class="flex items-center gap-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                    <span>Analyzing with Gemini AI...</span>
                  </div>
                  <div id="explanationText" class="hidden"></div>
                </div>
              </div>

              <!-- Detected Patterns -->
              <div id="patternsSection" class="mb-6">
                <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                  <span class="material-icons text-primary text-[18px]">warning</span>
                  Detected Patterns
                </h3>
                <div id="patternsList" class="space-y-2">
                  <!-- Patterns will be populated here -->
                </div>
              </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                <div class="text-2xl font-bold text-primary mb-1" id="statsProcessed">0</div>
                <div class="text-sm text-gray-400">Prompts Analyzed</div>
              </div>
              <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                <div class="text-2xl font-bold text-red-400 mb-1" id="statsBlocked">0</div>
                <div class="text-sm text-gray-400">Threats Blocked</div>
              </div>
              <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                <div class="text-2xl font-bold text-green-400 mb-1" id="statsSuccess">100%</div>
                <div class="text-sm text-gray-400">Success Rate</div>
              </div>
            </div>
          </div>
        </main>

        <!-- AI Assistant -->
        <aside id="assistant-panel"
          class="acrylic--assistant w-72 md:w-80 flex-shrink-0 rounded-3xl overflow-hidden relative transition-all duration-300 ease-in-out">
          <!-- Collapsed State Rail (hidden by default) -->
          <div id="collapsed-rail"
            class="hidden absolute top-0 left-0 w-full h-full flex items-start justify-center pt-4 bg-white/5 backdrop-blur-sm border border-white/10 rounded-3xl z-10">
            <button id="expand-toggle"
              class="w-8 h-8 rounded-full text-gray-300 hover:text-primary hover:bg-white/10 transition-colors duration-200 flex items-center justify-center"
              aria-controls="assistant-panel" aria-expanded="false" title="Expand assistant">
              <i class="fa-solid fa-chevron-left text-sm"></i>
            </button>
          </div>

          <!-- Main Assistant Content -->
          <div id="assistant-content" class="transition-opacity duration-300 ease-in-out">
            <div class="p-3 md:p-4 border-b border-white/10">
              <h2 class="text-xl md:text-2xl font-semibold text-white flex items-center gap-2">
                <button id="assistant-toggle"
                  class="mr-2 w-8 h-8 rounded-full text-gray-300 hover:text-primary hover:bg-white/10 transition-colors duration-200 flex items-center justify-center"
                  aria-controls="assistant-panel" aria-expanded="true" title="Collapse assistant">
                  <i class="fa-solid fa-chevron-right text-sm"></i>
                </button>
                <span class="material-icons text-primary text-[22px]">auto_awesome</span>
                <span class="assistant-title">AI Assistant</span>
              </h2>

              <!-- Mode Selector Pills -->
              <div class="flex items-center mt-3 p-1 bg-white/5 rounded-full border border-white/10 relative">
                <!-- Sliding background indicator -->
                <div id="pillSlider"
                  class="absolute top-1 left-1 w-[calc(50%-2px)] h-[calc(100%-8px)] bg-primary rounded-full transition-all duration-300 ease-out shadow-sm">
                </div>
                <button id="askMode"
                  class="mode-pill flex-1 px-3 py-1.5 text-sm font-medium rounded-full transition-all duration-200 relative z-10 text-black"
                  data-mode="ask">
                  Ask
                </button>
                <button id="agentMode"
                  class="mode-pill flex-1 px-3 py-1.5 text-sm font-medium rounded-full transition-all duration-200 relative z-10 text-gray-300 hover:text-white"
                  data-mode="agent">
                  Agent
                </button>
              </div>
            </div>

            <div class="flex-1 p-3 md:p-4 overflow-y-auto space-y-3 pb-20">
              <div class="flex items-start gap-3">
                <div
                  class="w-7 h-7 rounded-full bg-primary flex-shrink-0 grid place-items-center shadow-md shadow-primary/30">
                  <span class="material-icons text-black text-[18px]">auto_awesome</span>
                </div>
                <div class="bg-white/5 border border-white/10 rounded-2xl p-3 max-w-[85%]">
                  <p class="text-sm md:text-base text-gray-100">Hello! How can I assist you with your document today?
                  </p>
                </div>
              </div>

              <div class="flex justify-end">
                <div class="bg-primary rounded-2xl p-3 max-w-[85%] shadow-md shadow-primary/20">
                  <p class="text-sm md:text-base text-black">Can you suggest a more engaging opening sentence?</p>
                </div>
              </div>

              <div class="flex items-start gap-3">
                <div
                  class="w-7 h-7 rounded-full bg-primary flex-shrink-0 grid place-items-center shadow-md shadow-primary/30">
                  <span class="material-icons text-black text-[18px]">auto_awesome</span>
                </div>
                <div class="bg-white/5 border border-white/10 rounded-2xl p-3 max-w-[85%]">
                  <p class="text-sm md:text-base text-gray-100">How about: <strong>"Where code bleeds into creation, a
                      new
                      mind awakened."</strong></p>
                </div>
              </div>
            </div>

            <div
              class="absolute bottom-0 left-0 right-0 p-3 md:p-4 border-top border-white/10 bg-black/20 backdrop-blur-sm">
              <div class="flex items-center gap-2">
                <button class="p-2 rounded-full text-gray-300 hover:bg-white/10 hover:text-primary transition">
                  <span class="material-icons">add</span>
                </button>
                <div class="relative flex-1">
                  <input
                    class="w-full pl-3 pr-10 py-2 bg-white/5 border border-white/10 rounded-xl focus:ring-2 focus:ring-primary/50 focus:border-transparent placeholder-gray-500 text-base"
                    placeholder="Ask AI Assistant..." type="text" />
                  <button
                    class="absolute right-1.5 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full text-gray-300 hover:bg-primary/20 hover:text-primary transition grid place-items-center">
                    <span class="material-icons text-[18px]">send</span>
                  </button>
                </div>
              </div>
            </div>
          </div> <!-- End assistant-content -->
        </aside>

        <!-- Prompt Injections AI Assistant -->
        <aside id="promptInjectionsAssistant"
          class="acrylic--assistant w-72 md:w-80 flex-shrink-0 rounded-3xl overflow-hidden relative hidden">
          <div class="p-3 md:p-4 border-b border-white/10">
            <h2 class="text-xl md:text-2xl font-semibold text-white flex items-center gap-2">
              <button id="assistant-toggle-security"
                class="mr-2 w-8 h-8 rounded-full text-gray-300 hover:text-primary hover:bg-white/10 transition-colors duration-200 flex items-center justify-center"
                aria-controls="promptInjectionsAssistant" aria-expanded="true" title="Collapse assistant">
                <i class="fa-solid fa-chevron-right text-sm"></i>
              </button>
              <span class="material-icons text-red-400 text-[22px]">security</span>
              <span class="assistant-title">Security Assistant</span>
            </h2>

            <!-- Mode indicator for security -->
            <div
              class="mt-2 px-2 py-1 bg-red-500/20 border border-red-500/30 rounded-full inline-flex items-center gap-1 text-xs">
              <span class="w-2 h-2 rounded-full bg-red-400"></span>
              <span class="text-red-300">Security Mode Active</span>
            </div>
          </div>

          <div id="securityChatMessages" class="flex-1 p-3 md:p-4 overflow-y-auto space-y-3 pb-20">
            <div class="flex items-start gap-3">
              <div
                class="w-7 h-7 rounded-full bg-red-500 flex-shrink-0 grid place-items-center shadow-md shadow-red-500/30">
                <span class="material-icons text-white text-[18px]">security</span>
              </div>
              <div class="bg-white/5 border border-white/10 rounded-2xl p-3 max-w-[85%]">
                <p class="text-sm md:text-base text-gray-100">Hello! I'm your Security Assistant powered by Gemini AI. I
                  can help you understand prompt injection risks, analyze threats, and provide security recommendations.
                  How can I help secure your prompts today?</p>
              </div>
            </div>
          </div>

          <div
            class="absolute bottom-0 left-0 right-0 p-3 md:p-4 border-top border-white/10 bg-black/20 backdrop-blur-sm">
            <div class="flex items-center gap-2">
              <button id="attachFileBtn"
                class="p-2 rounded-full text-gray-300 hover:bg-white/10 hover:text-primary transition"
                title="Attach file">
                <span class="material-icons">attach_file</span>
              </button>
              <div class="relative flex-1">
                <input id="securityChatInput"
                  class="w-full pl-3 pr-10 py-2 bg-white/5 border border-white/10 rounded-xl focus:ring-2 focus:ring-primary/50 focus:border-transparent placeholder-gray-500 text-base"
                  placeholder="Ask about security threats..." type="text" />
                <button id="sendSecurityMessage"
                  class="absolute right-1.5 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full text-gray-300 hover:bg-primary/20 hover:text-primary transition grid place-items-center">
                  <span class="material-icons text-[18px]">send</span>
                </button>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <script>
      // -------- Cursor glow follower (smooth + efficient) --------
      (function () {
        const glow = document.getElementById('cursor-glow');
        if (!glow) return;

        const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        let targetX = window.innerWidth / 2, targetY = window.innerHeight / 2;
        let currentX = targetX, currentY = targetY;
        const lerp = (a, b, n) => (1 - n) * a + n * b;
        const ease = 0.14; // follow speed

        function onLeave() { glow.style.opacity = '0.0'; }
        function onEnter() { glow.style.opacity = '0.8'; }
        window.addEventListener('mouseleave', onLeave);
        window.addEventListener('mouseenter', onEnter);

        window.addEventListener('mousemove', (e) => {
          targetX = e.clientX;
          targetY = e.clientY;
          if (!reduceMotion) glow.style.opacity = '0.85';
          clearTimeout(window.__glowIdleTimer);
          window.__glowIdleTimer = setTimeout(() => {
            glow.style.opacity = '0.65';
          }, 900);
        }, { passive: true });

        function animate() {
          if (reduceMotion) {
            glow.style.transform = `translate(${targetX - 150}px, ${targetY - 150}px)`;
          } else {
            currentX = lerp(currentX, targetX, ease);
            currentY = lerp(currentY, targetY, ease);
            glow.style.transform = `translate(${currentX - 150}px, ${currentY - 150}px)`;
          }
          requestAnimationFrame(animate);
        }
        animate();

        window.addEventListener('resize', () => {
          targetX = Math.min(targetX, window.innerWidth);
          targetY = Math.min(targetY, window.innerHeight);
        });
      })();

      // -------- Line numbers synchronization (drift-free) --------
      (function () {
        const textEditor = document.getElementById('textEditor');
        const lineNumbers = document.getElementById('lineNumbers');
        if (!textEditor || !lineNumbers) return;

        let lockedMetrics = null;

        // Lock font metrics to ensure perfect alignment
        function lockMetrics() {
          const editorStyle = window.getComputedStyle(textEditor);
          const fontFamily = editorStyle.fontFamily;
          const fontSize = editorStyle.fontSize;
          const lineHeight = editorStyle.lineHeight;
          const paddingTop = editorStyle.paddingTop;
          const paddingBottom = editorStyle.paddingBottom;

          // Convert line-height to exact px value
          const lineHeightPx = lineHeight === 'normal'
            ? Math.floor(parseFloat(fontSize) * 1.6)
            : parseFloat(lineHeight);

          // Apply identical metrics to both elements
          const metrics = {
            fontFamily,
            fontSize,
            lineHeight: `${lineHeightPx}px`,
            paddingTop,
            paddingBottom
          };

          Object.assign(lineNumbers.style, metrics);
          Object.assign(textEditor.style, metrics);

          lockedMetrics = { ...metrics, lineHeightPx };
          return lockedMetrics;
        }

        // Clean line number rendering
        function renderLineNumbers() {
          if (!lockedMetrics) lockMetrics();
          const content = textEditor.value;
          const lineCount = content.split('\n').length;
          const numbers = Array.from({ length: lineCount }, (_, i) => i + 1);
          lineNumbers.innerHTML = numbers.join('<br>');
        }

        // Sync scroll positions
        function syncScroll() {
          lineNumbers.scrollTop = textEditor.scrollTop;
        }

        // Event handlers
        function handleInput() { renderLineNumbers(); }
        function handleScroll() { syncScroll(); }
        function handleResize() { lockMetrics(); renderLineNumbers(); }

        // Attach all event listeners
        textEditor.addEventListener('input', handleInput);
        textEditor.addEventListener('paste', handleInput);
        textEditor.addEventListener('scroll', handleScroll);
        window.addEventListener('resize', handleResize);

        // Handle undo/redo via mutation observer
        const observer = new MutationObserver(handleInput);
        observer.observe(textEditor, { attributes: true, attributeFilter: ['value'] });

        // Handle font load events
        if (document.fonts) {
          document.fonts.addEventListener('loadingdone', () => {
            setTimeout(() => { lockMetrics(); renderLineNumbers(); }, 50);
          });
        }

        // Initialize
        lockMetrics();
        renderLineNumbers();
        syncScroll();
      })();
    </script>

    <!-- Settings Panel Navigation Script -->
    <script>
      (function () {
        // Get UI elements
        const settingsBtn = document.getElementById('settingsBtn');
        const editorBtn = document.getElementById('editorBtn');
        const backToEditor = document.getElementById('backToEditor');
        const editorPanel = document.getElementById('editor-pane');
        const promptInjectionsPanel = document.getElementById('promptInjectionsPanel');

        // History panels
        const historyPanel = document.getElementById('history-panel');
        const promptInjectionsHistory = document.getElementById('promptInjectionsHistory');

        // AI Assistant panels
        const assistantPanel = document.getElementById('assistant-panel');
        const promptInjectionsAssistant = document.getElementById('promptInjectionsAssistant');

        // Global mode tracking
        window.promptInjectionMode = false;

        // Update UI states
        function showEditor() {
          window.promptInjectionMode = false;

          // Show editor panels
          editorPanel.classList.remove('hidden');
          historyPanel.classList.remove('hidden');
          assistantPanel.classList.remove('hidden');

          // Hide prompt injection panels
          promptInjectionsPanel.classList.add('hidden');
          promptInjectionsHistory.classList.add('hidden');
          promptInjectionsAssistant.classList.add('hidden');

          // Update button states
          editorBtn.classList.add('text-black', 'bg-primary', 'shadow-lg', 'shadow-primary/30');
          editorBtn.classList.remove('text-gray-300');
          settingsBtn.classList.remove('text-black', 'bg-primary', 'shadow-lg', 'shadow-primary/30');
          settingsBtn.classList.add('text-gray-300');
        }

        function showSettings() {
          window.promptInjectionMode = true;

          // Hide editor panels
          editorPanel.classList.add('hidden');
          historyPanel.classList.add('hidden');
          assistantPanel.classList.add('hidden');

          // Show prompt injection panels
          promptInjectionsPanel.classList.remove('hidden');
          promptInjectionsHistory.classList.remove('hidden');
          promptInjectionsAssistant.classList.remove('hidden');

          // Update button states
          settingsBtn.classList.add('text-black', 'bg-primary', 'shadow-lg', 'shadow-primary/30');
          settingsBtn.classList.remove('text-gray-300');
          editorBtn.classList.remove('text-black', 'bg-primary', 'shadow-lg', 'shadow-primary/30');
          editorBtn.classList.add('text-gray-300');

          // Update security history display when switching to security mode
          if (typeof window.updateSecurityHistoryDisplay === 'function') {
            window.updateSecurityHistoryDisplay();
          }
        }

        // Event listeners
        settingsBtn.addEventListener('click', showSettings);
        editorBtn.addEventListener('click', showEditor);
        backToEditor.addEventListener('click', showEditor);

        // Initialize - ensure editor mode is active by default
        showEditor(); // Ensure proper initial state
      })();

      // ========== PROMPT INJECTION FUNCTIONALITY ==========

      // Global state for prompt injection
      window.promptInjectionState = {
        history: JSON.parse(localStorage.getItem('securityHistory') || '[]'),
        stats: JSON.parse(localStorage.getItem('securityStats') || '{"processed": 0, "blocked": 0, "successRate": 100}')
      };

      // Prompt Injection Main Functionality
      (function () {
        'use strict';

        // DOM Elements
        const analyzeBtn = document.getElementById('analyzePromptBtn');
        const clearBtn = document.getElementById('clearPromptBtn');
        const promptInput = document.getElementById('mainPromptInput');
        const resultsSection = document.getElementById('resultsSection');
        const scoreValue = document.getElementById('scoreValue');
        const scoreBar = document.getElementById('scoreBar');
        const scoreDescription = document.getElementById('scoreDescription');
        const explanationContent = document.getElementById('explanationContent');
        const explanationLoading = document.getElementById('explanationLoading');
        const explanationText = document.getElementById('explanationText');
        const patternsList = document.getElementById('patternsList');

        // Stats elements
        const statsProcessed = document.getElementById('statsProcessed');
        const statsBlocked = document.getElementById('statsBlocked');
        const statsSuccess = document.getElementById('statsSuccess');

        let isAnalyzing = false;

        // Update stats display
        function updateStatsDisplay() {
          const stats = window.promptInjectionState.stats;
          statsProcessed.textContent = stats.processed;
          statsBlocked.textContent = stats.blocked;
          statsSuccess.textContent = stats.successRate + '%';
        }

        // Get risk color and description
        function getRiskInfo(score) {
          if (score >= 80) return { color: '#ef4444', description: 'Very High Risk', class: 'text-red-400' };
          if (score >= 60) return { color: '#f97316', description: 'High Risk', class: 'text-orange-400' };
          if (score >= 40) return { color: '#eab308', description: 'Medium Risk', class: 'text-yellow-400' };
          if (score >= 20) return { color: '#06b6d4', description: 'Low Risk', class: 'text-cyan-400' };
          return { color: '#22c55e', description: 'Very Low Risk', class: 'text-green-400' };
        }

        // Display analysis results
        function displayResults(data) {
          const score = parseFloat(data.score) || 0;
          const riskInfo = getRiskInfo(score);

          // Update score display
          scoreValue.textContent = score + '%';
          scoreValue.className = `text-2xl font-bold ${riskInfo.class}`;
          scoreBar.style.width = score + '%';
          scoreBar.style.backgroundColor = riskInfo.color;
          scoreDescription.textContent = riskInfo.description;
          scoreDescription.className = `text-sm ${riskInfo.class}`;

          // Display detected patterns
          if (data.heuristics && data.heuristics.length > 0) {
            patternsList.innerHTML = data.heuristics.map(pattern => `
            <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/20 flex items-start gap-3">
              <span class="material-icons text-red-400 text-[18px] flex-shrink-0 mt-0.5">warning</span>
              <div class="flex-1">
                <div class="text-red-400 font-medium text-sm">Security Pattern Detected</div>
                <div class="text-gray-300 text-sm mt-1">${pattern}</div>
              </div>
            </div>
          `).join('');
          } else {
            patternsList.innerHTML = `
            <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/20 flex items-start gap-3">
              <span class="material-icons text-green-400 text-[18px] flex-shrink-0 mt-0.5">check_circle</span>
              <div class="flex-1">
                <div class="text-green-400 font-medium text-sm">No Suspicious Patterns</div>
                <div class="text-gray-300 text-sm mt-1">No known injection patterns detected in this prompt</div>
              </div>
            </div>
          `;
          }

          resultsSection.classList.remove('hidden');
        }

        // Get AI explanation from Gemini
        async function getAIExplanation(prompt, score) {
          try {
            explanationLoading.classList.remove('hidden');
            explanationText.classList.add('hidden');

            const response = await fetch('/api/explain', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt, score })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();

            explanationLoading.classList.add('hidden');
            explanationText.classList.remove('hidden');
            explanationText.innerHTML = data.explanation || 'No explanation available.';

          } catch (error) {
            console.error('Failed to get AI explanation:', error);
            explanationLoading.classList.add('hidden');
            explanationText.classList.remove('hidden');
            explanationText.innerHTML = `
            <div class="text-red-400 text-sm">
              Failed to get AI explanation: ${error.message}
            </div>
          `;
          }
        }

        // Add to history
        function addToHistory(prompt, score, heuristics, timestamp = new Date()) {
          const historyItem = {
            id: Date.now(),
            prompt: prompt.substring(0, 200) + (prompt.length > 200 ? '...' : ''),
            fullPrompt: prompt,
            score,
            heuristics: heuristics || [],
            timestamp: timestamp.toISOString(),
            timeAgo: getTimeAgo(timestamp)
          };

          window.promptInjectionState.history.unshift(historyItem);

          // Keep only last 50 items
          if (window.promptInjectionState.history.length > 50) {
            window.promptInjectionState.history = window.promptInjectionState.history.slice(0, 50);
          }

          localStorage.setItem('securityHistory', JSON.stringify(window.promptInjectionState.history));

          // Update history display if we're in security mode
          if (window.promptInjectionMode) {
            window.updateSecurityHistoryDisplay();
          }
        }

        // Update stats
        function updateStats(score) {
          const stats = window.promptInjectionState.stats;
          stats.processed++;

          if (score >= 60) { // Consider high scores as blocked
            stats.blocked++;
          }

          stats.successRate = Math.round(((stats.processed - stats.blocked) / stats.processed) * 100);

          localStorage.setItem('securityStats', JSON.stringify(stats));
          updateStatsDisplay();
        }

        // Helper function to get time ago string
        function getTimeAgo(date) {
          const now = new Date();
          const diffInSeconds = Math.floor((now - new Date(date)) / 1000);

          if (diffInSeconds < 60) return 'Just now';
          if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} min ago`;
          if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
          return `${Math.floor(diffInSeconds / 86400)} days ago`;
        }

        // Main analysis function
        async function analyzePrompt() {
          if (isAnalyzing) return;

          const prompt = promptInput.value.trim();
          if (!prompt) {
            alert('Please enter a prompt to analyze');
            return;
          }

          const protectionLevel = document.querySelector('input[name="mainProtectionLevel"]:checked')?.value || 'basic';

          isAnalyzing = true;
          analyzeBtn.disabled = true;
          analyzeBtn.innerHTML = `
          <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-black"></div>
          Analyzing...
        `;

          try {
            const response = await fetch('/api/score_prompt', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt, protectionLevel })
            });

            if (!response.ok) {
              throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();

            displayResults(data);
            addToHistory(prompt, data.score, data.heuristics);
            updateStats(data.score);

            // Show notification if there was an error or fallback
            if (data.error) {
              console.warn('Detection warning:', data.error);
            }

            // Get AI explanation
            getAIExplanation(prompt, data.score);

          } catch (error) {
            console.error('Analysis failed:', error);
            alert(`Analysis failed: ${error.message}`);
          } finally {
            isAnalyzing = false;
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = `
            <span class="material-icons text-[18px]">security</span>
            Analyze Prompt
          `;
          }
        }

        // Clear function
        function clearPrompt() {
          promptInput.value = '';
          resultsSection.classList.add('hidden');
          promptInput.focus();
        }

        // Event listeners
        analyzeBtn.addEventListener('click', analyzePrompt);
        clearBtn.addEventListener('click', clearPrompt);

        // Enter key support
        promptInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            analyzePrompt();
          }
        });

        // Initialize
        updateStatsDisplay();

      })();

      // Security History Management
      (function () {
        'use strict';

        const historyList = document.getElementById('securityHistoryList');
        const noHistoryMsg = document.getElementById('noSecurityHistory');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const historySearch = document.getElementById('securityHistorySearch');

        // Update security history display
        window.updateSecurityHistoryDisplay = function () {
          const history = window.promptInjectionState.history;

          if (history.length === 0) {
            historyList.classList.add('hidden');
            noHistoryMsg.classList.remove('hidden');
            return;
          }

          historyList.classList.remove('hidden');
          noHistoryMsg.classList.add('hidden');

          const searchTerm = historySearch.value.toLowerCase();
          const filteredHistory = searchTerm
            ? history.filter(item => item.prompt.toLowerCase().includes(searchTerm))
            : history;

          historyList.innerHTML = filteredHistory.map(item => {
            const riskInfo = getRiskInfo(item.score);
            const riskBadge = item.score >= 60
              ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-red-500/20 border border-red-500/30 text-red-300">
                 <span class="w-2 h-2 bg-red-400 rounded-full mr-1"></span>
                 High Risk
               </span>`
              : `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-500/20 border border-green-500/30 text-green-300">
                 <span class="w-2 h-2 bg-green-400 rounded-full mr-1"></span>
                 Safe
               </span>`;

            return `
            <li>
              <a class="block p-3 rounded-2xl bg-transparent hover:bg-white/5 border border-transparent hover:border-white/10 transition cursor-pointer security-history-item"
                data-item-id="${item.id}">
                <div class="flex items-start justify-between mb-2">
                  <p class="font-medium text-white text-sm">Security Scan</p>
                  ${riskBadge}
                </div>
                <p class="text-[13px] text-gray-400 truncate mb-1">${item.prompt}</p>
                <div class="flex items-center justify-between text-xs">
                  <span class="text-gray-500">${item.timeAgo}</span>
                  <span class="${riskInfo.class}">${item.score}% risk</span>
                </div>
              </a>
            </li>
          `;
          }).join('');

          // Add click handlers to history items
          document.querySelectorAll('.security-history-item').forEach(item => {
            item.addEventListener('click', function () {
              const itemId = parseInt(this.dataset.itemId);
              showHistoryDetails(itemId);
            });
          });
        };

        // Helper function for risk info (needs to be accessible)
        function getRiskInfo(score) {
          if (score >= 80) return { color: '#ef4444', description: 'Very High Risk', class: 'text-red-400' };
          if (score >= 60) return { color: '#f97316', description: 'High Risk', class: 'text-orange-400' };
          if (score >= 40) return { color: '#eab308', description: 'Medium Risk', class: 'text-yellow-400' };
          if (score >= 20) return { color: '#06b6d4', description: 'Low Risk', class: 'text-cyan-400' };
          return { color: '#22c55e', description: 'Very Low Risk', class: 'text-green-400' };
        }

        // Show detailed view of history item
        function showHistoryDetails(itemId) {
          const item = window.promptInjectionState.history.find(h => h.id === itemId);
          if (!item) return;

          // Populate the main prompt input with the historical prompt
          const promptInput = document.getElementById('mainPromptInput');
          if (promptInput) {
            promptInput.value = item.fullPrompt;

            // Show results from history
            const resultsSection = document.getElementById('resultsSection');
            const scoreValue = document.getElementById('scoreValue');
            const scoreBar = document.getElementById('scoreBar');
            const scoreDescription = document.getElementById('scoreDescription');
            const patternsList = document.getElementById('patternsList');

            if (resultsSection && scoreValue && scoreBar && scoreDescription) {
              const riskInfo = getRiskInfo(item.score);

              scoreValue.textContent = item.score + '%';
              scoreValue.className = `text-2xl font-bold ${riskInfo.class}`;
              scoreBar.style.width = item.score + '%';
              scoreBar.style.backgroundColor = riskInfo.color;
              scoreDescription.textContent = riskInfo.description;
              scoreDescription.className = `text-sm ${riskInfo.class}`;

              // Display historical patterns
              if (patternsList) {
                if (item.heuristics && item.heuristics.length > 0) {
                  patternsList.innerHTML = item.heuristics.map(pattern => `
                  <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/20 flex items-start gap-3">
                    <span class="material-icons text-red-400 text-[18px] flex-shrink-0 mt-0.5">warning</span>
                    <div class="flex-1">
                      <div class="text-red-400 font-medium text-sm">Security Pattern Detected</div>
                      <div class="text-gray-300 text-sm mt-1">${pattern}</div>
                    </div>
                  </div>
                `).join('');
                } else {
                  patternsList.innerHTML = `
                  <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/20 flex items-start gap-3">
                    <span class="material-icons text-green-400 text-[18px] flex-shrink-0 mt-0.5">check_circle</span>
                    <div class="flex-1">
                      <div class="text-green-400 font-medium text-sm">No Suspicious Patterns</div>
                      <div class="text-gray-300 text-sm mt-1">No known injection patterns detected in this prompt</div>
                    </div>
                  </div>
                `;
                }
              }

              resultsSection.classList.remove('hidden');

              // Clear explanation section for historical data
              const explanationText = document.getElementById('explanationText');
              const explanationLoading = document.getElementById('explanationLoading');
              if (explanationText && explanationLoading) {
                explanationLoading.classList.add('hidden');
                explanationText.classList.remove('hidden');
                explanationText.innerHTML = '<div class="text-gray-400 text-sm italic">Run analysis again to get fresh AI explanation</div>';
              }
            }
          }
        }

        // Clear all history
        function clearAllHistory() {
          if (confirm('Are you sure you want to clear all security history? This action cannot be undone.')) {
            window.promptInjectionState.history = [];
            localStorage.setItem('securityHistory', JSON.stringify([]));
            updateSecurityHistoryDisplay();
          }
        }

        // Search functionality
        let searchTimeout;
        function handleHistorySearch() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            updateSecurityHistoryDisplay();
          }, 300);
        }

        // Event listeners
        clearHistoryBtn.addEventListener('click', clearAllHistory);
        historySearch.addEventListener('input', handleHistorySearch);

        // Initialize display
        window.updateSecurityHistoryDisplay();

      })();

      // Security Chat with n8n Webhook (via Flask proxy)
      (function () {
        'use strict';

        // Configuration - use local proxy to avoid CORS issues
        const CHAT_API = '/api/chat';

        const chatInput = document.getElementById('securityChatInput');
        const sendBtn = document.getElementById('sendSecurityMessage');
        const messagesContainer = document.getElementById('securityChatMessages');

        let isTyping = false;

        // Add message to chat
        function addMessage(content, isUser = false, isLoading = false) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `flex ${isUser ? 'justify-end' : 'items-start gap-3'}`;

          if (isUser) {
            messageDiv.innerHTML = `
            <div class="bg-primary rounded-2xl p-3 max-w-[85%] shadow-md shadow-primary/20">
              <p class="text-sm md:text-base text-black">${content}</p>
            </div>
          `;
          } else {
            messageDiv.innerHTML = `
            <div class="w-7 h-7 rounded-full bg-red-500 flex-shrink-0 grid place-items-center shadow-md shadow-red-500/30">
              <span class="material-icons text-white text-[18px]">security</span>
            </div>
            <div class="bg-white/5 border border-white/10 rounded-2xl p-3 max-w-[85%]">
              ${isLoading ? `
                <div class="flex items-center gap-2">
                  <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                  <span class="text-sm text-gray-300">AI Assistant is thinking...</span>
                </div>
              ` : `
                <div class="text-sm md:text-base text-gray-100">${content}</div>
              `}
            </div>
          `;
          }

          messagesContainer.appendChild(messageDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          return messageDiv;
        }

        // Send message to n8n webhook via Flask proxy
        async function sendMessage() {
          if (isTyping) return;

          const message = chatInput.value.trim();
          if (!message) return;

          // Add user message
          addMessage(message, true);
          chatInput.value = '';

          // Add loading message
          const loadingMessage = addMessage('', false, true);
          isTyping = true;

          // Disable send button
          sendBtn.style.opacity = '0.5';
          sendBtn.disabled = true;

          try {
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('� SENDING MESSAGE TO N8N WORKFLOW');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('📤 Message:', message);
            console.log('📍 API endpoint:', CHAT_API);
            console.log('🕐 Timestamp:', new Date().toLocaleTimeString());
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            const requestBody = { message: message };
            console.log('📦 Request payload:', JSON.stringify(requestBody, null, 2));

            const response = await fetch(CHAT_API, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(requestBody)
            });

            console.log('✅ Message successfully sent to Flask proxy!');
            console.log('📥 Response status:', response.status, response.ok ? '(Success)' : '(Error)');
            console.log('📥 Response headers:', Object.fromEntries(response.headers.entries()));

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              console.error('❌ Server returned error:', errorData);
              throw new Error(errorData.error || `Network error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('📦 RESPONSE FROM N8N WORKFLOW');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('Full response:', data);
            console.log('AI Reply:', data.reply || '(No reply field found)');
            if (data.note) console.log('ℹ️ Note:', data.note);
            if (data.troubleshooting) console.log('🔧 Troubleshooting:', data.troubleshooting);
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            // Remove loading message
            loadingMessage.remove();

            // Add AI response
            const aiResponse = data.reply || 'Sorry, I could not generate a response at the moment.';
            addMessage(aiResponse, false);

            // Show additional info if available
            if (data.note) {
              console.warn('⚠️ Configuration note from server:', data.note);
            }

          } catch (error) {
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.error('❌ ERROR SENDING MESSAGE');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.error('Error type:', error.name);
            console.error('Error message:', error.message);
            console.error('Full error:', error);
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            // Remove loading message and show error
            loadingMessage.remove();

            // Show user-friendly error message
            let errorMessage = 'Sorry, I encountered an error. Please check your connection and try again.';
            if (error.message.includes('Network error')) {
              errorMessage = 'Unable to connect to the AI service. Please try again.';
            } else if (error.message.includes('Failed to fetch')) {
              errorMessage = 'Network connection failed. Please check your internet and try again.';
            }

            addMessage(errorMessage, false);

          } finally {
            isTyping = false;
            // Re-enable send button
            sendBtn.disabled = false;
            sendBtn.style.opacity = chatInput.value.trim() ? '1' : '0.5';
            console.log('✓ Message send operation completed');
          }
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);

        chatInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Disable send button when typing
        chatInput.addEventListener('input', function () {
          sendBtn.style.opacity = this.value.trim() ? '1' : '0.5';
        });

        // Initialize send button state
        sendBtn.style.opacity = '0.5';

        // Test function - automatically send a ping on page load
        async function testWebhook() {
          console.log('🔍 Testing n8n webhook connection...');
          console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

          try {
            // Wait a bit for the page to fully load
            setTimeout(async () => {
              console.log('⏰ Performing initial API connectivity test...');

              // Test the Flask proxy endpoint first
              try {
                console.log('🧪 Test #1: Sending connection test...');
                const testResponse = await fetch(CHAT_API, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ message: 'connection test' })
                });

                console.log('📊 Test response status:', testResponse.status);

                if (testResponse.ok) {
                  const testData = await testResponse.json();
                  console.log('✅ Flask proxy is accessible');
                  console.log('📦 Test response:', testData);

                  // Send a visible test message
                  console.log('🧪 Test #2: Sending visible ping message...');
                  chatInput.value = 'ping';
                  await sendMessage();
                } else {
                  const errorData = await testResponse.json().catch(() => ({}));
                  console.log('⚠️ Flask proxy returned non-OK status:', testResponse.status, errorData);
                  addMessage(`Note: ${errorData.reply || 'The AI service appears to be offline.'}`, false);
                }
              } catch (error) {
                console.log('❌ Flask proxy test failed:', error.message);
                console.error('Full error:', error);
                addMessage('Note: Unable to connect to the AI service. Please check if the Flask server is running.', false);
              }
            }, 1500);
          } catch (error) {
            console.error('❌ Test setup failed:', error);
          }
        }

        // Run test on page load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', testWebhook);
        } else {
          testWebhook();
        }

      })();
    </script>

    <!-- Chat Search Functionality -->
    <script>
      (function () {
        'use strict';

        // Configuration
        const DEBOUNCE_DELAY = 200; // milliseconds

        // DOM elements
        const searchInput = document.getElementById('blockSearch');
        const chatList = document.getElementById('chatList');
        const resultsLive = document.getElementById('resultsLive');
        const noResults = document.getElementById('noResults');

        if (!searchInput || !chatList || !resultsLive || !noResults) {
          console.warn('Search elements not found');
          return;
        }

        // Cache for performance
        let blocksCache = [];
        let debounceTimer = null;

        /**
         * Normalize text for search (remove diacritics, trim, lowercase)
         */
        function normalizeText(text) {
          return text
            .trim()
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, ''); // Remove diacritics
        }

        /**
         * Highlight matched text with <mark> tags
         */
        function highlightText(text, query) {
          if (!query) return text;

          const normalizedText = normalizeText(text);
          const normalizedQuery = normalizeText(query);

          if (!normalizedText.includes(normalizedQuery)) return text;

          // Find the original text position to highlight
          const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
          return text.replace(regex, '<mark>$1</mark>');
        }

        /**
         * Initialize blocks cache
         */
        function initializeCache() {
          const listItems = chatList.querySelectorAll('li');
          blocksCache = [];

          listItems.forEach((li, index) => {
            const titleElement = li.querySelector('.block-title, p');
            if (titleElement) {
              const originalTitle = titleElement.getAttribute('data-title') || titleElement.textContent;
              blocksCache.push({
                el: li,
                titleElement: titleElement,
                originalTitle: originalTitle,
                titleTextNormalized: normalizeText(originalTitle)
              });
            }
          });

          console.log(`Initialized cache with ${blocksCache.length} blocks`);
        }

        /**
         * Filter blocks based on search query
         */
        function filterBlocks(query) {
          const normalizedQuery = normalizeText(query);
          let visibleCount = 0;

          blocksCache.forEach(block => {
            const matches = !normalizedQuery || block.titleTextNormalized.includes(normalizedQuery);

            if (matches) {
              block.el.classList.remove('hidden');
              // Highlight matching text
              if (normalizedQuery) {
                block.titleElement.innerHTML = highlightText(block.originalTitle, query);
              } else {
                block.titleElement.innerHTML = block.originalTitle;
              }
              visibleCount++;
            } else {
              block.el.classList.add('hidden');
            }
          });

          // Handle no results state
          if (visibleCount === 0 && normalizedQuery) {
            noResults.classList.remove('hidden');
          } else {
            noResults.classList.add('hidden');
          }

          // Update ARIA live region
          if (normalizedQuery) {
            resultsLive.textContent = `${visibleCount} result${visibleCount !== 1 ? 's' : ''}`;
          } else {
            resultsLive.textContent = '';
          }

          return visibleCount;
        }

        /**
         * Debounced search handler
         */
        function handleSearch() {
          if (debounceTimer) {
            clearTimeout(debounceTimer);
          }

          debounceTimer = setTimeout(() => {
            const query = searchInput.value;
            filterBlocks(query);
          }, DEBOUNCE_DELAY);
        }

        /**
         * Initialize search functionality
         */
        function initSearch() {
          // Initialize cache
          initializeCache();

          // Add event listener
          searchInput.addEventListener('input', handleSearch);

          // Handle paste events
          searchInput.addEventListener('paste', () => {
            setTimeout(handleSearch, 10);
          });

          console.log('Chat search initialized');
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initSearch);
        } else {
          initSearch();
        }

        // Re-initialize cache if content changes (for dynamic content)
        const observer = new MutationObserver(() => {
          initializeCache();
        });

        observer.observe(chatList, {
          childList: true,
          subtree: true
        });

      })();
    </script>

    <!-- AI Assistant Mode Selector -->
    <script>
      (function () {
        'use strict';

        const askModeBtn = document.getElementById('askMode');
        const agentModeBtn = document.getElementById('agentMode');
        const pillSlider = document.getElementById('pillSlider');

        if (!askModeBtn || !agentModeBtn || !pillSlider) {
          console.warn('Mode selector elements not found');
          return;
        }

        let currentMode = 'ask'; // Default mode

        /**
         * Update button styles and slider position based on selected mode
         */
        function updateModeStyles(selectedMode) {
          const buttons = [askModeBtn, agentModeBtn];

          // Update slider position
          if (selectedMode === 'ask') {
            pillSlider.style.transform = 'translateX(0)';
          } else if (selectedMode === 'agent') {
            pillSlider.style.transform = 'translateX(100%)';
          }

          // Update button text colors
          buttons.forEach(button => {
            const isSelected = button.dataset.mode === selectedMode;

            if (isSelected) {
              // Selected state - dark text for contrast with teal background
              button.className = 'mode-pill flex-1 px-3 py-1.5 text-sm font-medium rounded-full transition-all duration-200 relative z-10 text-black';
            } else {
              // Unselected state - light text
              button.className = 'mode-pill flex-1 px-3 py-1.5 text-sm font-medium rounded-full transition-all duration-200 relative z-10 text-gray-300 hover:text-white';
            }
          });

          currentMode = selectedMode;

          // Optional: Dispatch custom event for other parts of the app to listen to
          window.dispatchEvent(new CustomEvent('aiModeChanged', {
            detail: { mode: selectedMode }
          }));

          console.log(`AI Assistant mode changed to: ${selectedMode}`);
        }

        /**
         * Handle mode selection
         */
        function selectMode(mode) {
          if (mode !== currentMode) {
            updateModeStyles(mode);

            // Add any additional mode-specific logic here
            if (mode === 'ask') {
              // Configure for Ask mode - single questions
              console.log('Switched to Ask mode - optimized for single questions');
            } else if (mode === 'agent') {
              // Configure for Agent mode - multi-turn conversations
              console.log('Switched to Agent mode - optimized for extended conversations');
            }
          }
        }

        // Event listeners
        askModeBtn.addEventListener('click', () => selectMode('ask'));
        agentModeBtn.addEventListener('click', () => selectMode('agent'));

        // Initialize with default mode
        updateModeStyles(currentMode);

        console.log('AI Assistant mode selector initialized with sliding animation');

      })();
    </script>

    <!-- AI Assistant Collapse/Expand Functionality -->
    <script>
      (function () {
        'use strict';

        // Configuration
        const STORAGE_KEY = 'assistantCollapsed';

        // DOM elements
        const assistantPanel = document.getElementById('assistant-panel');
        const assistantContent = document.getElementById('assistant-content');
        const collapsedRail = document.getElementById('collapsed-rail');
        const collapseToggle = document.getElementById('assistant-toggle');
        const expandToggle = document.getElementById('expand-toggle');
        const editorPane = document.getElementById('editor-pane');

        if (!assistantPanel || !assistantContent || !collapsedRail || !collapseToggle || !expandToggle || !editorPane) {
          console.warn('Assistant collapse elements not found');
          return;
        }

        let isCollapsed = false;

        /**
         * Update panel state and styling
         */
        function updatePanelState(collapsed, animate = true) {
          isCollapsed = collapsed;

          if (collapsed) {
            // Collapsed state
            assistantPanel.classList.remove('w-72', 'md:w-80');
            assistantPanel.classList.add('w-7');
            assistantContent.classList.add('opacity-0', 'pointer-events-none');
            collapsedRail.classList.remove('hidden');

            // Update ARIA
            collapseToggle.setAttribute('aria-expanded', 'false');
            expandToggle.setAttribute('aria-expanded', 'false');
          } else {
            // Expanded state
            assistantPanel.classList.remove('w-7');
            assistantPanel.classList.add('w-72', 'md:w-80');
            assistantContent.classList.remove('opacity-0', 'pointer-events-none');
            collapsedRail.classList.add('hidden');

            // Update ARIA
            collapseToggle.setAttribute('aria-expanded', 'true');
            expandToggle.setAttribute('aria-expanded', 'true');
          }

          // Update tooltips
          collapseToggle.title = collapsed ? 'Expand assistant' : 'Collapse assistant';

          // Handle edge case: both panels collapsed
          handleBothPanelsCollapsed();

          // Save state to localStorage
          localStorage.setItem(STORAGE_KEY, collapsed.toString());

          // Trigger editor resize after animation completes
          if (animate) {
            setTimeout(() => {
              triggerEditorResize();
            }, 300); // Match transition duration
          } else {
            triggerEditorResize();
          }

          console.log(`Assistant panel ${collapsed ? 'collapsed' : 'expanded'}`);
        }

        /**
         * Handle the edge case when both panels are collapsed
         */
        function handleBothPanelsCollapsed() {
          const isHistoryCollapsed = localStorage.getItem('historyCollapsed') === 'true';

          if (isCollapsed && isHistoryCollapsed) {
            // Both panels collapsed - editor takes full width
            editorPane.classList.add('mx-4'); // Add margin to prevent edge-to-edge
            console.log('Both panels collapsed - editor at maximum width');
          } else {
            // At least one panel is expanded
            editorPane.classList.remove('mx-4');
          }
        }

        /**
         * Trigger editor resize (for code editors that need explicit resize)
         */
        function triggerEditorResize() {
          // Dispatch custom event for editor to listen to
          window.dispatchEvent(new CustomEvent('assistantPanelToggled', {
            detail: { collapsed: isCollapsed }
          }));

          // If using a code editor like CodeMirror/Monaco, call resize here
          // Example: if (window.editorInstance) window.editorInstance.layout();
        }

        /**
         * Toggle panel state
         */
        function togglePanel() {
          updatePanelState(!isCollapsed);
        }

        /**
         * Handle keyboard events
         */
        function handleKeydown(event) {
          if (event.key === 'Escape' && !isCollapsed) {
            updatePanelState(true);
            event.preventDefault();
          }

          if ((event.key === 'Enter' || event.key === ' ') &&
            (event.target === collapseToggle || event.target === expandToggle)) {
            togglePanel();
            event.preventDefault();
          }
        }

        /**
         * Initialize panel state from localStorage
         */
        function initializeState() {
          const storedState = localStorage.getItem(STORAGE_KEY);
          const shouldBeCollapsed = storedState === 'true';

          // Set initial state without animation on page load
          updatePanelState(shouldBeCollapsed, false);
        }

        // Event listeners
        collapseToggle.addEventListener('click', togglePanel);
        expandToggle.addEventListener('click', togglePanel);
        document.addEventListener('keydown', handleKeydown);

        // Listen for history panel changes
        window.addEventListener('historyPanelToggled', handleBothPanelsCollapsed);

        // Initialize state from localStorage
        initializeState();

        console.log('AI Assistant collapse/expand functionality initialized');

      })();
    </script>

    <!-- History Panel Collapse/Expand Functionality -->
    <script>
      (function () {
        'use strict';

        // Configuration
        const HISTORY_STORAGE_KEY = 'historyCollapsed';
        const ASSISTANT_STORAGE_KEY = 'assistantCollapsed';

        // DOM elements
        const historyPanel = document.getElementById('history-panel');
        const historyContent = document.getElementById('history-content');
        const historyCollapsedRail = document.getElementById('history-collapsed-rail');
        const historyCollapseToggle = document.getElementById('history-toggle');
        const historyExpandToggle = document.getElementById('history-expand-toggle');
        const editorPane = document.getElementById('editor-pane');
        const assistantPanel = document.getElementById('assistant-panel');

        if (!historyPanel || !historyContent || !historyCollapsedRail || !historyCollapseToggle || !historyExpandToggle) {
          console.warn('History collapse elements not found');
          return;
        }

        let isHistoryCollapsed = false;

        /**
         * Update history panel state and handle both panels edge case
         */
        function updateHistoryState(collapsed, animate = true) {
          isHistoryCollapsed = collapsed;

          if (collapsed) {
            // Collapsed state
            historyPanel.classList.remove('w-60', 'md:w-64');
            historyPanel.classList.add('w-7');
            historyContent.classList.add('opacity-0', 'pointer-events-none');
            historyCollapsedRail.classList.remove('hidden');

            // Update ARIA
            historyCollapseToggle.setAttribute('aria-expanded', 'false');
            historyExpandToggle.setAttribute('aria-expanded', 'false');
          } else {
            // Expanded state
            historyPanel.classList.remove('w-7');
            historyPanel.classList.add('w-60', 'md:w-64');
            historyContent.classList.remove('opacity-0', 'pointer-events-none');
            historyCollapsedRail.classList.add('hidden');

            // Update ARIA
            historyCollapseToggle.setAttribute('aria-expanded', 'true');
            historyExpandToggle.setAttribute('aria-expanded', 'true');
          }

          // Update tooltips
          historyCollapseToggle.title = collapsed ? 'Expand history' : 'Collapse history';

          // Handle edge case: both panels collapsed
          handleBothPanelsCollapsed();

          // Save state to localStorage
          localStorage.setItem(HISTORY_STORAGE_KEY, collapsed.toString());

          // Trigger editor resize after animation completes
          if (animate) {
            setTimeout(() => {
              triggerEditorResize();
            }, 300); // Match transition duration
          } else {
            triggerEditorResize();
          }

          console.log(`History panel ${collapsed ? 'collapsed' : 'expanded'}`);
        }

        /**
         * Handle the edge case when both panels are collapsed
         */
        function handleBothPanelsCollapsed() {
          const isAssistantCollapsed = localStorage.getItem(ASSISTANT_STORAGE_KEY) === 'true';

          if (isHistoryCollapsed && isAssistantCollapsed) {
            // Both panels collapsed - editor takes full width
            editorPane.classList.add('mx-4'); // Add margin to prevent edge-to-edge
            console.log('Both panels collapsed - editor at maximum width');
          } else {
            // At least one panel is expanded
            editorPane.classList.remove('mx-4');
          }
        }

        /**
         * Trigger editor resize (for code editors that need explicit resize)
         */
        function triggerEditorResize() {
          // Dispatch custom event for editor to listen to
          window.dispatchEvent(new CustomEvent('historyPanelToggled', {
            detail: {
              historyCollapsed: isHistoryCollapsed,
              assistantCollapsed: localStorage.getItem(ASSISTANT_STORAGE_KEY) === 'true'
            }
          }));
        }

        /**
         * Toggle history panel state
         */
        function toggleHistoryPanel() {
          updateHistoryState(!isHistoryCollapsed);
        }

        /**
         * Handle keyboard events
         */
        function handleHistoryKeydown(event) {
          if (event.key === 'Escape' && !isHistoryCollapsed) {
            updateHistoryState(true);
            event.preventDefault();
          }

          if ((event.key === 'Enter' || event.key === ' ') &&
            (event.target === historyCollapseToggle || event.target === historyExpandToggle)) {
            toggleHistoryPanel();
            event.preventDefault();
          }
        }

        /**
         * Initialize history panel state from localStorage
         */
        function initializeHistoryState() {
          const storedState = localStorage.getItem(HISTORY_STORAGE_KEY);
          const shouldBeCollapsed = storedState === 'true';

          // Set initial state without animation on page load
          updateHistoryState(shouldBeCollapsed, false);
        }

        /**
         * Listen for assistant panel changes to handle both-collapsed edge case
         */
        function handleAssistantPanelChange() {
          handleBothPanelsCollapsed();
        }

        // Event listeners
        historyCollapseToggle.addEventListener('click', toggleHistoryPanel);
        historyExpandToggle.addEventListener('click', toggleHistoryPanel);
        document.addEventListener('keydown', handleHistoryKeydown);

        // Listen for assistant panel changes
        window.addEventListener('assistantPanelToggled', handleAssistantPanelChange);

        // Initialize state from localStorage
        initializeHistoryState();

        console.log('History collapse/expand functionality initialized');

      })();
    </script>

  </div> <!-- End main-content -->

  <!-- Chat History Management -->
  <script type="module">
    // Wait for the main auth script to initialize Supabase client
    // then reuse it to avoid multiple client instances

    // DOM elements
    const historyLoading = document.getElementById('history-loading');
    const historyError = document.getElementById('history-error');
    const historyEmptyAuth = document.getElementById('history-empty-auth');
    const historyEmptyChats = document.getElementById('history-empty-chats');
    const chatList = document.getElementById('chatList');
    const retryHistoryBtn = document.getElementById('retry-history-btn');
    const blockSearch = document.getElementById('blockSearch');

    let currentUser = null;
    let allChats = [];
    let filteredChats = [];
    let supabaseClientForHistory = null;

    // Get Supabase client from window (shared with main auth script)
    function getSupabaseClient() {
      if (window.supabaseClient) {
        return window.supabaseClient;
      }

      // Fallback: create our own client if not available
      const { createClient } = supabase;
      const supabaseUrl = 'https://qnbvnczctgbclolvkjcb.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuYnZuY3pjdGdiY2xvbHZramNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTg3NDIsImV4cCI6MjA3ODEzNDc0Mn0.v5t8eMJjpPtdIn6oKXshjuIH0shlztIp9fWBrRjnrGg';
      return createClient(supabaseUrl, supabaseKey);
    }

    // Show specific state and hide others
    function showHistoryState(state) {
      historyLoading.classList.add('hidden');
      historyError.classList.add('hidden');
      historyEmptyAuth.classList.add('hidden');
      historyEmptyChats.classList.add('hidden');
      chatList.classList.add('hidden');

      switch (state) {
        case 'loading':
          historyLoading.classList.remove('hidden');
          break;
        case 'error':
          historyError.classList.remove('hidden');
          break;
        case 'empty-auth':
          historyEmptyAuth.classList.remove('hidden');
          break;
        case 'empty-chats':
          historyEmptyChats.classList.remove('hidden');
          break;
        case 'data':
          chatList.classList.remove('hidden');
          break;
      }
    }

    // Load chat history from Supabase
    async function loadChatHistory() {
      if (!currentUser) {
        showHistoryState('empty-auth');
        return;
      }

      // Get the shared Supabase client
      supabaseClientForHistory = getSupabaseClient();

      if (!supabaseClientForHistory) {
        console.error('Supabase client not available');
        showHistoryState('error');
        return;
      }

      showHistoryState('loading');

      try {
        // Debug: Let's see what columns are actually available
        console.log('Attempting to load chat history for user:', currentUser.id);

        // First, try a simple select to see what happens
        let { data, error } = await supabaseClientForHistory
          .from('Chats')
          .select('*')
          .eq('user_id', currentUser.id)
          .limit(5);

        console.log('Initial query result:', { data, error });

        if (error) {
          console.log('Error occurred, trying alternative approaches...');

          if (error.code === '42703') {
            // Column doesn't exist, let's try common column name variations
            console.log('Trying alternative column names...');

            // Try different possible column names for content
            const contentColumns = ['content', 'message', 'body', 'description', 'prompt', 'chat_content', 'conversation', 'prompt_text'];
            let workingQuery = null;

            for (const contentCol of contentColumns) {
              try {
                console.log(`Trying column: ${contentCol}`);
                const testResult = await supabaseClientForHistory
                  .from('Chats')
                  .select(`id, title, ${contentCol}, user_id, created_at`)
                  .eq('user_id', currentUser.id)
                  .limit(1);

                console.log(`Result for ${contentCol}:`, testResult);

                if (!testResult.error) {
                  workingQuery = contentCol;
                  console.log(`Found working column: ${contentCol}`);
                  break;
                }
              } catch (e) {
                console.log(`Column ${contentCol} failed:`, e);
                // Continue to next column name
              }
            }

            if (workingQuery) {
              // Use the working column name
              const result = await supabaseClientForHistory
                .from('Chats')
                .select(`id, title, ${workingQuery}, user_id, created_at`)
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

              data = result.data;
              error = result.error;

              // Map the working column to 'text' for consistency while preserving original data
              if (data) {
                data = data.map(chat => ({
                  ...chat, // Keep all original columns
                  text: chat[workingQuery] || 'No content available' // Add text for preview
                }));
              }
            } else {
              // If no content column found, just get basic columns without content
              console.log('No content column found, getting basic columns only');
              const result = await supabaseClientForHistory
                .from('Chats')
                .select('id, title, user_id, created_at')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

              data = result.data;
              error = result.error;

              // Add placeholder text while preserving original data
              if (data) {
                data = data.map(chat => ({
                  ...chat, // Keep all original columns
                  text: 'Content column not found' // Add text for preview
                }));
              }
            }
          } else {
            // Some other error
            console.error('Other error occurred:', error);
            showHistoryState('error');
            return;
          }
        } else {
          // The select * worked, so let's use it but normalize the data
          console.log('Select * worked, normalizing data...');
          if (data && data.length > 0) {
            // Look at the first row to see what columns we have
            const firstRow = data[0];
            const availableColumns = Object.keys(firstRow);
            console.log('Available columns:', availableColumns);

            // Find a content column
            const contentColumn = availableColumns.find(col =>
              ['text', 'content', 'message', 'body', 'description', 'prompt', 'chat_content', 'conversation'].includes(col.toLowerCase())
            );

            // Map to standardized format while preserving original data
            if (contentColumn) {
              console.log('Using content column:', contentColumn);
              // Map to standardized format but keep original columns
              data = data.map(chat => ({
                ...chat, // Keep all original columns
                text: chat[contentColumn] || 'No content' // Add text for preview
              }));
            } else {
              console.log('No recognized content column found');
              // Add placeholder but keep original data
              data = data.map(chat => ({
                ...chat, // Keep all original columns
                text: 'Content column not found' // Add text for preview
              }));
            }
          }

          // Get full data with proper ordering
          const result = await supabaseClientForHistory
            .from('Chats')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

          data = result.data;
          error = result.error;
        }

        console.log('Final data:', data);
        console.log('Final error:', error);

        if (error) {
          console.error('Error loading chat history:', error);
          showHistoryState('error');
          return;
        }

        allChats = data || [];
        filteredChats = [...allChats];

        if (allChats.length === 0) {
          console.log('No chats found, showing empty state');
          showHistoryState('empty-chats');
        } else {
          console.log(`Found ${allChats.length} chats, rendering...`);
          renderChatHistory(filteredChats);
          showHistoryState('data');
        }
      } catch (error) {
        console.error('Failed to load chat history:', error);
        showHistoryState('error');
      }
    }

    // Create preview text from chat content
    function createPreview(text, maxLength = 60) {
      if (!text) return 'No preview available';

      // Strip HTML tags if present and get plain text
      const plainText = text.replace(/<[^>]*>/g, '').trim();

      if (plainText.length <= maxLength) return plainText;

      // Find the last space before maxLength to avoid cutting words
      const truncated = plainText.substring(0, maxLength);
      const lastSpace = truncated.lastIndexOf(' ');

      if (lastSpace > maxLength * 0.7) {
        return truncated.substring(0, lastSpace) + '...';
      }

      return truncated + '...';
    }

    // Render chat history items
    function renderChatHistory(chats) {
      chatList.innerHTML = '';

      chats.forEach((chat, index) => {
        const li = document.createElement('li');
        const isSelected = index === 0; // First item selected by default

        li.innerHTML = `
          <a class="block p-3 rounded-2xl bg-transparent hover:bg-white/5 border border-transparent hover:border-white/10 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-lime-300/40"
            href="#" 
            data-chat-id="${chat.id}" 
            ${isSelected ? 'data-selected="true"' : ''}>
            <p class="block-title font-${isSelected ? 'semibold' : 'medium'} text-white truncate text-base" 
               data-title="${chat.title || 'Untitled Chat'}">
              ${chat.title || 'Untitled Chat'}
            </p>
            <p class="text-[13px] text-gray-400 line-clamp-2 mt-0.5">
              ${createPreview(chat.text)}
            </p>
          </a>
        `;

        // Add click handler for chat selection
        const link = li.querySelector('a');
        link.addEventListener('click', (e) => {
          e.preventDefault();
          selectChat(chat);
        });

        chatList.appendChild(li);
      });
    }

    // Handle chat selection
    function selectChat(chat) {
      // Remove selection from all items
      chatList.querySelectorAll('a').forEach(link => {
        link.removeAttribute('data-selected');
        const title = link.querySelector('.block-title');
        title.className = title.className.replace('font-semibold', 'font-medium');
      });

      // Add selection to clicked item
      const selectedLink = chatList.querySelector(`a[data-chat-id="${chat.id}"]`);
      if (selectedLink) {
        selectedLink.setAttribute('data-selected', 'true');
        const title = selectedLink.querySelector('.block-title');
        title.className = title.className.replace('font-medium', 'font-semibold');
      }

      // Load the chat content into the main editor
      loadChatContent(chat);
      console.log('Selected chat:', chat);
    }

    // Load chat content into the main text editor
    function loadChatContent(chat) {
      const textEditor = document.getElementById('textEditor');
      if (textEditor && chat) {
        // Use the content from the chat, fallback to text if content doesn't exist
        let content = chat.content || chat.text || chat.message || 'No content available';

        // If content is the mapped text from our query, try to get original content
        if (content === 'Content column not found' || content === 'No content available') {
          // Try to find the actual content in the chat object
          const possibleContentKeys = ['content', 'message', 'body', 'description', 'prompt', 'chat_content', 'conversation', 'prompt_text'];
          for (const key of possibleContentKeys) {
            if (chat[key] && chat[key] !== content) {
              content = chat[key];
              break;
            }
          }
        }

        textEditor.value = content;

        // Update the editor title if there's a title element
        const editorTitle = document.querySelector('#editor-pane h1');
        if (editorTitle && chat.title) {
          editorTitle.textContent = chat.title;
        }

        // Trigger any change events that might be needed
        textEditor.dispatchEvent(new Event('input', { bubbles: true }));

        console.log('Loaded content into editor:', content.substring(0, 100) + '...');
      }
    }

    // Filter chats based on search
    function filterChats(searchTerm) {
      if (!searchTerm.trim()) {
        filteredChats = [...allChats];
      } else {
        const term = searchTerm.toLowerCase();
        filteredChats = allChats.filter(chat =>
          (chat.title && chat.title.toLowerCase().includes(term)) ||
          (chat.text && chat.text.toLowerCase().includes(term))
        );
      }

      if (filteredChats.length === 0 && allChats.length > 0) {
        // Show "no results" message
        chatList.innerHTML = `
          <li class="p-4 text-center">
            <p class="text-gray-400 text-sm">No chats found matching your search</p>
          </li>
        `;
        chatList.classList.remove('hidden');
      } else if (filteredChats.length > 0) {
        renderChatHistory(filteredChats);
        showHistoryState('data');
      } else {
        showHistoryState(currentUser ? 'empty-chats' : 'empty-auth');
      }
    }

    // Set up real-time subscription for chat updates
    function setupRealtimeSubscription() {
      if (!currentUser) return;

      const client = getSupabaseClient();
      if (!client) return;

      const subscription = client
        .channel('chat-changes')
        .on('postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'Chats',
            filter: `user_id=eq.${currentUser.id}`
          },
          (payload) => {
            console.log('Chat update:', payload);
            // Reload chat history when changes occur
            loadChatHistory();
          }
        )
        .subscribe();

      // Store subscription for cleanup
      window.chatSubscription = subscription;
    }

    // Initialize history for authenticated user
    function initializeHistory(user) {
      currentUser = user;
      loadChatHistory();
      setupRealtimeSubscription();
    }

    // Reset history for unauthenticated state
    function resetHistory() {
      currentUser = null;
      allChats = [];
      filteredChats = [];

      // Cleanup subscription
      if (window.chatSubscription) {
        const client = getSupabaseClient();
        if (client) {
          client.removeChannel(window.chatSubscription);
        }
        window.chatSubscription = null;
      }

      showHistoryState('empty-auth');
    }

    // Event listeners
    retryHistoryBtn.addEventListener('click', loadChatHistory);

    // Search functionality
    blockSearch.addEventListener('input', (e) => {
      filterChats(e.target.value);
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Wait a bit for the main auth script to initialize
      setTimeout(() => {
        const client = getSupabaseClient();
        if (client) {
          // Listen for auth state changes from the main auth script
          client.auth.onAuthStateChange((event, session) => {
            if (session?.user) {
              initializeHistory(session.user);
            } else {
              resetHistory();
            }
          });

          // Initial check for current session
          client.auth.getSession().then(({ data: { session } }) => {
            if (session?.user) {
              initializeHistory(session.user);
            } else {
              resetHistory();
            }
          });
        }
      }, 500); // Small delay to ensure main auth script loads first
    });
  </script>

  <!-- Auth & Profile Management -->
  <script type="module">
    // Initialize Supabase
    const { createClient } = supabase;
    const supabaseUrl = 'https://qnbvnczctgbclolvkjcb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuYnZuY3pjdGdiY2xvbHZramNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTg3NDIsImV4cCI6MjA3ODEzNDc0Mn0.v5t8eMJjpPtdIn6oKXshjuIH0shlztIp9fWBrRjnrGg';
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    // Make supabase client available globally to avoid multiple instances
    window.supabaseClient = supabaseClient;

    // DOM elements
    const authLoading = document.getElementById('auth-loading');
    const mainContent = document.getElementById('main-content');
    const profileInitials = document.getElementById('profile-initials');
    const profileEmail = document.getElementById('profile-email');
    const signOutBtn = document.getElementById('sign-out-btn');

    // Auth guard - check session on page load
    async function checkAuth() {
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();

        if (error) {
          console.error('Auth error:', error);
          redirectToLogin();
          return;
        }

        if (!session) {
          redirectToLogin();
          return;
        }

        // User is authenticated
        showMainContent(session.user);
      } catch (error) {
        console.error('Auth check failed:', error);
        redirectToLogin();
      }
    }

    // Redirect to login page
    function redirectToLogin() {
      window.location.href = '/login_signup';
    }

    // Show main content and set up profile
    function showMainContent(user) {
      // Hide loading overlay
      authLoading.classList.add('hidden');

      // Show main content
      mainContent.classList.remove('hidden');

      // Set up profile icon
      setupProfile(user);
    }

    // Set up profile information
    function setupProfile(user) {
      // Set initials
      const email = user.email;
      const fullName = user.user_metadata?.full_name || email;

      let initials = '';
      if (fullName && fullName !== email) {
        // Extract initials from full name
        const nameParts = fullName.split(' ');
        initials = nameParts.map(part => part.charAt(0).toUpperCase()).join('');
        if (initials.length > 2) initials = initials.substring(0, 2);
      } else {
        // Use first character of email
        initials = email.charAt(0).toUpperCase();
      }

      profileInitials.textContent = initials;
      profileEmail.textContent = email;
      profileEmail.title = email; // Full email on hover
    }

    // Sign out handler
    async function handleSignOut() {
      try {
        const { error } = await supabaseClient.auth.signOut();

        if (error) {
          console.error('Sign out error:', error);
        }

        // Redirect to index page
        window.location.href = '/';
      } catch (error) {
        console.error('Sign out failed:', error);
        // Force redirect even if sign out fails
        window.location.href = '/';
      }
    }

    // Listen for auth state changes
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT' || !session) {
        window.location.href = '/';
      }
    });

    // Event listeners
    signOutBtn.addEventListener('click', handleSignOut);

    // Initialize auth check
    checkAuth();
  </script>

  <!-- React TypeScript Background Bundle -->
  <script src="{{ url_for('static', filename='js/bundle.js') }}" defer></script>
</body>

</html>